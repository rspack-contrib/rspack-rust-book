<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Create a Loader - Rspack Rust Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../res/mermaid-anti-flash.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rspack Rust Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rspack-contrib/rspack-rust-book/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rspack-contrib/rspack-rust-book/tree/main/src/custom-binding/create-a-loader.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="create-a-loader"><a class="header" href="#create-a-loader">Create a Loader</a></h1>
<p>This chapter explores creating a custom loader for Rspack using the <code>MyBannerLoader</code> example. While the loader is already implemented in the template, we'll walk you through creating this loader from scratch and using it in JavaScript. This demonstrates the complete workflow from Rust implementation to JavaScript integration.</p>
<h2 id="what-is-builtinmy-banner-loader"><a class="header" href="#what-is-builtinmy-banner-loader">What is <code>builtin:my-banner-loader</code>?</a></h2>
<p><code>builtin:my-banner-loader</code> is a simple loader that prepends a configurable banner comment to the top of modules.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before starting this tutorial, ensure you've completed the <a href="./first-custom-binding/setup.html">setup process</a> and can successfully run the example plugin.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>We'll guide you through the loader creation process in these steps:</p>
<ol>
<li><strong>Understand the Loader Structure</strong> - Examine the basic Rust loader structure</li>
<li><strong>Implement the Loader Logic</strong> - Understand how the banner functionality works with async traits and caching</li>
<li><strong>Loader Plugin Integration</strong> - Learn how loaders are registered via plugins (critical step)</li>
<li><strong>NAPI Bindings</strong> - See how both loader and plugin functionality are exposed to JavaScript</li>
<li><strong>JavaScript Integration</strong> - Learn the two-step process: register plugin, then use loader</li>
<li><strong>Testing the Loader</strong> - Learn how to verify the loader works correctly</li>
</ol>
<blockquote>
<p><strong>⚠️ Important:</strong> Builtin loaders require plugin registration before they can be used in build configurations.</p>
</blockquote>
<p>Let's explore the <code>MyBannerLoader</code> implementation.</p>
<h2 id="1-understand-the-loader-structure"><a class="header" href="#1-understand-the-loader-structure">1. Understand the Loader Structure</a></h2>
<p><code>MyBannerLoader</code> is implemented in Rust and follows the standard loader structure with a companion plugin for registration.</p>
<ul>
<li><code>crates/binding/src/lib.rs</code> - The glue code that exports both the loader and plugin to JavaScript</li>
<li><code>crates/binding/src/loader.rs</code> - The <code>MyBannerLoader</code> implementation and <code>MyBannerLoaderPlugin</code></li>
</ul>
<h2 id="2-implement-the-loader-logic"><a class="header" href="#2-implement-the-loader-logic">2. Implement the Loader Logic</a></h2>
<p><code>MyBannerLoader</code> prepends a configurable banner comment to source files during the build process.</p>
<p>Before starting, add these dependencies to your <code>Cargo.toml</code> file:</p>
<ul>
<li><code>rspack_core</code> - The Rspack core API</li>
<li><code>rspack_error</code> - The Rspack error handling API</li>
<li><code>rspack_cacheable</code> - For making loaders cacheable</li>
<li><code>async_trait</code> - For async trait implementations</li>
</ul>
<h3 id="21-initialize-the-loader"><a class="header" href="#21-initialize-the-loader">2.1 Initialize the Loader</a></h3>
<p><code>MyBannerLoader</code> is implemented as a struct with a <code>banner</code> field containing the banner comment to prepend.</p>
<pre><code class="language-rust ignore">use std::sync::Arc;

use async_trait::async_trait;
use rspack_cacheable::{cacheable, cacheable_dyn, with::AsPreset};
use rspack_core::{
  Context, Loader, LoaderContext, LoaderRunnerContext, Plugin, PluginContext,
  PluginExt,
};
use rspack_error::{internal_error, Result};

#[cacheable]
#[derive(Debug)]
pub struct MyBannerLoader {
  banner: String,
}

impl MyBannerLoader {
  pub fn new(banner: String) -&gt; Self {
    Self { banner }
  }
}</code></pre>
<h3 id="22-implement-the-loader-trait-with-async-processing"><a class="header" href="#22-implement-the-loader-trait-with-async-processing">2.2 Implement the Loader Trait with Async Processing</a></h3>
<p>The loader implements the <code>Loader</code> trait using async processing and caching support.</p>
<blockquote>
<p><strong>Note:</strong> Use <code>#[rspack_cacheable::cacheable]</code> to make your loader cacheable, as Rspack binding supports persistent cache for better performance. This ensures unchanged files aren't reprocessed, significantly improving build times.</p>
</blockquote>
<pre><code class="language-rust ignore">#[rspack_cacheable::cacheable_dyn]
#[async_trait]
impl Loader for MyBannerLoader {
  async fn run(&amp;self, loader_context: &amp;mut LoaderContext&lt;LoaderRunnerContext&gt;) -&gt; Result&lt;()&gt; {
    let source = loader_context.take_content();

    if let Some(source) = source {
      let source = source.try_into_string()?;
      let source = format!("{}\n{}", self.banner, source);
      loader_context.finish_with(source);
    } else {
      loader_context.finish_with_empty();
    }
    Ok(())
  }
}


// Implement the Identifiable trait to provide a unique identifier for the loader
// This identifier is used by Rspack's internal caching system to identify
// and track this specific loader instance
impl rspack_collections::Identifiable for MyBannerLoader {
  fn identifier(&amp;self) -&gt; rspack_collections::Identifier {
    rspack_collections::Identifier::from("builtin:my-banner-loader")
  }
}</code></pre>
<h3 id="23-conclusion"><a class="header" href="#23-conclusion">2.3 Conclusion</a></h3>
<p>You've learned how to create a loader in Rust with async support and caching. The loader processes source content by prepending a banner string.</p>
<p>Next, you'll learn how to register this loader through a plugin.</p>
<h2 id="3-loader-plugin-integration"><a class="header" href="#3-loader-plugin-integration">3. Loader Plugin Integration</a></h2>
<p><strong>Critical Step:</strong> Custom loaders must be registered via a plugin before they can be used in build configurations. This is accomplished through a companion plugin.</p>
<h3 id="31-create-the-loader-plugin"><a class="header" href="#31-create-the-loader-plugin">3.1 Create the Loader Plugin</a></h3>
<pre><code class="language-rust ignore">#[plugin]
#[derive(Debug)]
pub struct MyBannerLoaderPlugin;

impl MyBannerLoaderPlugin {
  pub fn new() -&gt; Self {
    Self::new_inner()
  }
}

/// Resolves the `builtin:my-banner-loader` loader
#[plugin_hook(NormalModuleFactoryResolveLoader for MyBannerLoaderPlugin, tracing = false)]
pub(crate) async fn resolve_loader(
  &amp;self,
  _context: &amp;rspack_core::Context,
  _resolver: &amp;rspack_core::Resolver,
  loader: &amp;rspack_core::ModuleRuleUseLoader,
) -&gt; Result&lt;Option&lt;rspack_core::BoxLoader&gt;&gt; {
  if loader.loader.starts_with("builtin:my-banner-loader") {
    let banner = loader.options.clone().unwrap_or_default();
    return Ok(Some(Arc::new(MyBannerLoader::new(banner))));
  }

  Ok(None)
}

impl rspack_core::Plugin for MyBannerLoaderPlugin {
  fn apply(&amp;self, ctx: &amp;mut rspack_core::ApplyContext) -&gt; Result&lt;()&gt; {
    ctx
      .normal_module_factory_hooks
      .resolve_loader
      .tap(resolve_loader::new(self));
    Ok(())
  }
}</code></pre>
<h3 id="32-why-plugin-registration-is-required"><a class="header" href="#32-why-plugin-registration-is-required">3.2 Why Plugin Registration is Required</a></h3>
<p>Loaders must be registered in Rspack's loader resolution system. The <code>MyBannerLoaderPlugin</code>:</p>
<ol>
<li><strong>Registers the loader</strong> with a specific name (<code>builtin:my-banner-loader</code>)</li>
<li><strong>Makes it available</strong> for use in build configurations</li>
<li><strong>Integrates with</strong> Rspack's loader resolution mechanism</li>
</ol>
<p>Without this plugin registration, the loader won't be found when referenced in build configurations.</p>
<h3 id="33-conclusion"><a class="header" href="#33-conclusion">3.3 Conclusion</a></h3>
<p>You've learned that custom loaders require plugin registration. The companion plugin registers the loader in Rspack's resolution system, making it available for use.</p>
<p>Next, you'll learn how to expose both components to JavaScript.</p>
<h2 id="4-napi-bindings"><a class="header" href="#4-napi-bindings">4. NAPI Bindings</a></h2>
<p>This section covers exposing both the loader and its registration plugin to JavaScript using NAPI bindings.</p>
<h3 id="41-expose-both-components-to-javascript"><a class="header" href="#41-expose-both-components-to-javascript">4.1 Expose Both Components to JavaScript</a></h3>
<p>To use the loader in JavaScript, expose both the loader logic and the registration plugin.</p>
<p>Add these dependencies to your <code>Cargo.toml</code>:</p>
<ul>
<li><code>rspack_binding_builder</code> - Rspack binding builder API</li>
<li><code>rspack_binding_builder_macros</code> - Rspack binding builder macros</li>
<li><a href="https://docs.rs/napi/latest/napi/"><code>napi</code></a> - NAPI-RS crate</li>
<li><a href="https://docs.rs/napi_derive/latest/napi_derive/"><code>napi_derive</code></a> - NAPI-RS derive macro</li>
</ul>
<p>The <code>crates/binding/src/lib.rs</code> file exports both components to JavaScript:</p>
<pre><code class="language-rust ignore">mod loader;

use napi::bindgen_prelude::*;
use rspack_binding_builder_macros::register_plugin;
use rspack_core::BoxPlugin;

#[macro_use]
extern crate napi_derive;
extern crate rspack_binding_builder;

// Register the loader plugin that makes the loader available
register_plugin!("MyBannerLoaderPlugin", |_env: Env, _options: Unknown&lt;'_&gt;| {
  Ok(Box::new(loader::MyBannerLoaderPlugin::new()) as BoxPlugin)
});</code></pre>
<h3 id="42-registration-pattern"><a class="header" href="#42-registration-pattern">4.2 Registration Pattern</a></h3>
<p>The <code>register_plugin</code> macro creates the JavaScript binding for the plugin that registers our loader. This follows the same pattern as regular plugins but serves the specific purpose of loader registration.</p>
<h3 id="43-conclusion"><a class="header" href="#43-conclusion">4.3 Conclusion</a></h3>
<p>You've exposed the loader registration plugin to JavaScript. This allows registering the loader from JavaScript before using it in build configurations.</p>
<h2 id="5-javascript-integration"><a class="header" href="#5-javascript-integration">5. JavaScript Integration</a></h2>
<p>This section covers the two-step process for using custom loaders: register the plugin, then use the loader.</p>
<h3 id="51-create-javascript-plugin-wrapper"><a class="header" href="#51-create-javascript-plugin-wrapper">5.1 Create JavaScript Plugin Wrapper</a></h3>
<p>First, create a wrapper for the loader registration plugin in your <code>lib/index.js</code>:</p>
<pre><code class="language-js ignore">// Rewrite the RSPACK_BINDING environment variable
process.env.RSPACK_BINDING = require('node:path').dirname(
  require.resolve('@rspack-template/test-binding')
);

const binding = require('@rspack-template/test-binding');

// Register the loader plugin
binding.registerMyBannerLoaderPlugin();

const core = require('@rspack/core');

// Create wrapper for the loader registration plugin
const MyBannerLoaderPlugin = core.experiments.createNativePlugin(
  'MyBannerLoaderPlugin',
  function (options) {
    return options;
  }
);

// Export the plugin
Object.defineProperty(core, 'MyBannerLoaderPlugin', {
  value: MyBannerLoaderPlugin,
});

module.exports = core;
</code></pre>
<h3 id="52-two-step-usage-process"><a class="header" href="#52-two-step-usage-process">5.2 Two-Step Usage Process</a></h3>
<p><strong>Step 1: Register the Loader Plugin</strong></p>
<p>In your build configuration, first add the loader registration plugin:</p>
<pre><code class="language-js ignore">const path = require('node:path');
const rspack = require('@rspack-template/test-core');

const compiler = rspack({
  context: __dirname,
  mode: 'development',
  entry: {
    main: './src/index.js',
  },
  output: {
    path: path.resolve(__dirname, 'dist'),
  },
  plugins: [
    // Step 1: Register the loader
    new rspack.MyBannerLoaderPlugin(),
  ],
  // Step 2: Use the loader
  module: {
    rules: [
      {
        test: /\.js$/,
        use: [
          {
            loader: 'builtin:my-banner-loader',
            options: '/** Generated by builtin:my-banner-loader */',
          },
        ],
      },
    ],
  },
});
</code></pre>
<p><strong>Step 2: Configure the Loader</strong></p>
<p>Once the plugin is registered, you can use the loader in module rules with the registered name <code>builtin:my-banner-loader</code>.</p>
<h3 id="53-complete-example"><a class="header" href="#53-complete-example">5.3 Complete Example</a></h3>
<p>Check the <code>examples/use-loader/build.js</code> file in the <a href="https://github.com/rspack-contrib/rspack-binding-template/blob/main/examples/use-loader/build.js">rspack-binding-template</a> repository for a complete working example.</p>
<h2 id="6-testing-the-loader"><a class="header" href="#6-testing-the-loader">6. Testing the Loader</a></h2>
<p>Run the example to see the loader in action:</p>
<pre><code class="language-bash">node examples/use-loader/build.js
</code></pre>
<p>Check the output in the <code>dist/main.js</code> file to see the banner comment added to the top of the modules.</p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>You've learned how to:</p>
<ul>
<li>Create a cacheable loader in Rust with async processing</li>
<li>Understand the critical importance of plugin registration for custom loaders</li>
<li>Expose both loader and registration plugin to JavaScript using NAPI bindings</li>
<li>Follow the two-step process: register plugin first, then use loader</li>
<li>Configure and test the loader in build configurations</li>
</ul>
<p>This pattern can be extended to create more complex loaders for various source transformations. The key concepts of plugin registration and cacheable implementation remain consistent across different loader implementations.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../custom-binding/first-custom-binding/release.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../custom-binding/references/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../custom-binding/first-custom-binding/release.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../custom-binding/references/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../res/mermaid-anti-flash.js"></script>
        <script src="../res/mermaid.min.js"></script>
        <script src="../res/mermaid-init.js"></script>



    </div>
    </body>
</html>
